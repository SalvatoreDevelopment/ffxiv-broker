{% extends "base.html" %}
{% block title %}Analisi Mercato - FFXIV Market Advisor{% endblock %}

{% block content %}
<section class="mb-6">
  <h2 class="text-2xl font-bold mb-2">Analisi Mercato</h2>
  <p class="text-slate-600">Panoramica dei prezzi, volumi e opportunità di flip.</p>
</section>

<section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <div class="lg:col-span-2 card">
    <div class="card-header">Trend Prezzi</div>
    <div class="card-body">
      <canvas id="market-trend-chart" height="140"></canvas>
    </div>
  </div>
  <div class="card">
    <div class="card-header">Opportunità</div>
    <div class="card-body">
      <ul id="flip-ops" class="text-sm space-y-2"></ul>
    </div>
  </div>

  <!-- Fine sezione iniziale -->
</section>

<section class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
  <div class="card">
    <div class="card-header">Analizza Item (storico)</div>
    <div class="card-body space-y-3">
      <div class="space-y-2">
        <div class="relative">
          <input id="mi-search" type="text" class="input w-full" placeholder="Cerca item per nome" autocomplete="off" />
          <div id="mi-suggest" class="absolute z-10 bg-white border border-slate-200 rounded mt-1 w-full shadow hidden"></div>
        </div>
      </div>
      <div class="flex gap-2">
        <input id="mi-id" type="number" class="input w-40" placeholder="Item ID" />
        <button id="mi-load" class="btn btn-primary">Carica</button>
      </div>
      <canvas id="mi-chart" height="120"></canvas>
    </div>
  </div>
  <div class="lg:col-span-2 card">
    <div class="card-header">Dettagli</div>
    <div class="card-body text-sm">
      <div id="mi-details" class="text-slate-600">Seleziona un item per vedere lo storico prezzi e vendite.</div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const world = App.getWorld();
    try {
      const ov = await App.api.overview(world, 12);
      const items = ov.items || [];
      // Trend: vendite/giorno per item
      const labels = items.map(s => s.name || `Item ${s.item_id}`);
      const sales = items.map(s => s.sales_per_day_7d ?? 0);
      window.Dashboard?.mountMarketTrend?.('market-trend-chart', labels, sales);

      // Opportunità: mostra item con flag flip
      const ul = document.getElementById('flip-ops');
      const flips = items.filter(s => (s.flags || []).includes('flip'));
      if (!flips.length) {
        ul.innerHTML = '<li class="text-slate-500">Nessuna opportunità disponibile al momento.</li>';
      } else {
        ul.innerHTML = '';
        flips.slice(0, 10).forEach(s => {
          const li = document.createElement('li');
          li.className = 'hover:underline hover-pop flex justify-between gap-3';
          const price = App.fmt.gil(s.lowest ?? s.avg_price_7d ?? 0);
          const tags = (s.flags||[]).map(f=>`<span class="badge">${f}</span>`).join(' ');
          li.innerHTML = `<span>${s.name || 'Item ' + s.item_id}</span><span class="text-slate-600">${price} ${tags}</span>`;
          ul.appendChild(li);
        });
      }
    } catch (e) {
      console.warn('Errore caricamento mercato', e);
      document.getElementById('flip-ops').innerHTML = '<li class="text-red-600">Errore nel recupero dati</li>';
    }

    // Item history loader
    const loadBtn = document.getElementById('mi-load');
    const idInput = document.getElementById('mi-id');
    const searchInput = document.getElementById('mi-search');
    const suggestBox = document.getElementById('mi-suggest');

    const debounce = (fn, ms=200) => { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); }; };
    const hideSuggest = () => { suggestBox?.classList?.add('hidden'); suggestBox.innerHTML = ''; };
    const showSuggest = () => suggestBox?.classList?.remove('hidden');

    const renderSuggest = (items=[]) => {
      if (!suggestBox) return;
      if (!items.length) { hideSuggest(); return; }
      suggestBox.innerHTML = items.map(it => `
        <div class="px-3 py-2 hover:bg-slate-100 cursor-pointer" data-id="${it.item_id}" data-name="${it.name}">
          <span class="font-medium">${it.name || ('Item ' + it.item_id)}</span>
          <span class="text-slate-500 text-xs ml-2">#${it.item_id}</span>
        </div>
      `).join('');
      showSuggest();
      suggestBox.querySelectorAll('[data-id]')?.forEach(el => {
        el.addEventListener('click', () => {
          const iid = el.getAttribute('data-id');
          const nm = el.getAttribute('data-name');
          if (iid) {
            idInput.value = iid;
            if (nm) searchInput.value = nm;
            hideSuggest();
            loadBtn?.click();
          }
        });
      });
    };

    // Search input handler
    if (searchInput) {
      document.addEventListener('click', (e) => {
        if (!suggestBox?.contains(e.target) && e.target !== searchInput) hideSuggest();
      });
      searchInput.addEventListener('input', debounce(async () => {
        const q = searchInput.value.trim();
        if (q.length < 2) { hideSuggest(); return; }
        try {
          const res = await App.api.catalogSearch(q, 12);
          renderSuggest(res.items || []);
        } catch (e) {
          console.warn('catalog search error', e);
          hideSuggest();
        }
      }, 250));
      searchInput.addEventListener('focus', () => {
        const q = searchInput.value.trim();
        if (q.length >= 2 && suggestBox?.innerHTML) showSuggest();
      });
    }
    loadBtn?.addEventListener('click', async () => {
      const id = parseInt(idInput?.value || '0', 10);
      const w = App.getWorld();
      if (!id) return App.notify('Inserisci un Item ID', 'error');
      try {
        const stats = await App.api.marketItem(id, w);
        const raw = await App.json(`/market/item/${id}/raw?world=${encodeURIComponent(w)}`);
        const history = Array.isArray(raw.recentHistory) ? raw.recentHistory : [];
        const labels = history.map(h => new Date(h.timestamp * 1000).toLocaleDateString());
        const prices = history.map(h => h.pricePerUnit);
        window.Dashboard?.mountItemHistory?.('mi-chart', labels, prices);
        const lowest = stats.lowest != null ? App.fmt.gil(stats.lowest) : '-';
        const avg7 = stats.avg_price_7d != null ? App.fmt.gil(stats.avg_price_7d) : '-';
        const spd = App.fmt.number(stats.sales_per_day_7d, { maximumFractionDigits: 2 });
        document.getElementById('mi-details').innerHTML = `
          <div class="grid grid-cols-2 gap-2">
            <div><span class="text-slate-500">Lowest:</span> <span class="font-semibold">${lowest}</span></div>
            <div><span class="text-slate-500">Media 7g:</span> <span class="font-semibold">${avg7}</span></div>
            <div><span class="text-slate-500">Vendite/g:</span> <span class="font-semibold">${spd}</span></div>
            <div><span class="text-slate-500">Flags:</span> <span class="font-semibold">${(stats.flags||[]).join(', ')||'-'}</span></div>
          </div>`;
      } catch (e) {
        console.warn('Errore storico item', e);
        App.notify('Errore nel caricamento storico', 'error');
      }
    });
  });
</script>
{% endblock %}
